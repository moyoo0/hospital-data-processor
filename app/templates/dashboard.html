<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œå° - åŒ»é™¢æ•°æ®å¤„ç†ä¸­å¿ƒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .main-container {
            padding: 3rem 0;
        }
        .feature-card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s;
            height: 100%;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .card-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            color: #3498db;
        }
        .btn-action {
            border-radius: 30px;
            padding: 8px 25px;
        }
        .download-area {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 10px;
            border: 1px solid #c8e6c9;
        }
    </style>
</head>
<body>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#3498db" class="bi bi-hospital me-2" viewBox="0 0 16 16">
                    <path d="M8.5 5.034v1.1l.953-.55.5.867L9 7l.953.55-.5.866-.953-.55v1.1h-1v-1.1l-.953.55-.5-.866L7 7l-.953-.55.5-.866.953.55v-1.1h1ZM13.25 9a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5ZM13 11.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25v-.5Zm.25 1.75a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5Zm-11-4a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 3 9.75v-.5A.25.25 0 0 0 2.75 9h-.5Zm0 2.25a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 3 12v-.5A.25.25 0 0 0 2.75 11.25h-.5Zm0 2.25a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25h-.5Z"/>
                    <path d="M5 0a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1V0Zm2 4h2V1H7v3Zm3 9v-8.5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0-.5.5V13h6Z"/>
                </svg>
                åŒ»é™¢æ•°æ®å¤„ç†ä¸­å¿ƒ
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container main-container">
        <div class="row g-4">
            
            <!-- åŠŸèƒ½ 1: å•æ–‡ä»¶å¤„ç† -->
            <div class="col-md-6">
                <div class="card feature-card p-4">
                    <div class="card-body text-center">
                        <div class="card-icon">ğŸ“„</div>
                        <h3 class="card-title">å•æ–‡ä»¶å¤„ç†</h3>
                        <p class="card-text text-muted mb-4">
                            ä¸Šä¼ å•ä¸ª Excel æºæ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ¸…æ´—æ•°æ®ã€è¿›è¡Œåˆ†ç»„è®¡ç®—ï¼Œå¹¶ç”Ÿæˆå¸¦æœ‰åˆ¶è¡¨ä¿¡æ¯çš„æ ‡å‡†åŒ–æŠ¥è¡¨ã€‚
                        </p>
                        <button class="btn btn-primary btn-action" data-bs-toggle="modal" data-bs-target="#processModal">
                            ä¸Šä¼ æ–‡ä»¶
                        </button>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½ 2: æ‰¹é‡åˆå¹¶ -->
            <div class="col-md-6">
                <div class="card feature-card p-4">
                    <div class="card-body text-center">
                        <div class="card-icon">ğŸ“‘</div>
                        <h3 class="card-title">æ‰¹é‡åˆå¹¶</h3>
                        <p class="card-text text-muted mb-4">
                            ä¸€æ¬¡æ€§ä¸Šä¼ å¤šä¸ªæœˆä»½æˆ–ç§‘å®¤çš„ Excel æ–‡ä»¶ï¼Œç³»ç»Ÿå°†æ™ºèƒ½å¯¹é½è¡¨å¤´å¹¶åˆå¹¶æ•°æ®ï¼Œç”Ÿæˆæ±‡æ€»æŠ¥è¡¨ã€‚
                        </p>
                        <button class="btn btn-success btn-action" data-bs-toggle="modal" data-bs-target="#mergeModal">
                            æ‰¹é‡ä¸Šä¼ 
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- æ¨¡æ€æ¡† 1: å•æ–‡ä»¶å¤„ç† -->
    <div class="modal fade" id="processModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- modal-lg specifically for config editor -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å•æ–‡ä»¶å¤„ç†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="processForm">
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹© Excel æ–‡ä»¶</label>
                            <input type="file" class="form-control" id="srcFile" accept=".xls,.xlsx">
                            <div class="form-text">æ”¯æŒ .xls å’Œ .xlsx æ ¼å¼</div>
                        </div>

                        <!-- é«˜çº§è®¾ç½®: åˆ†ç»„é…ç½® -->
                        <div class="accordion mb-3" id="accordionConfig">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingConfig">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig">
                                        âš™ï¸ é«˜çº§è®¾ç½®ï¼šåˆ†ç»„æ˜ å°„è§„åˆ™
                                    </button>
                                </h2>
                                <div id="collapseConfig" class="accordion-collapse collapse" data-bs-parent="#accordionConfig">
                                    <div class="accordion-body">
                                        <div class="mb-2 d-flex justify-content-between align-items-center">
                                            <small class="text-muted">ä¿®æ”¹ä¸‹æ–¹çš„ JSON é…ç½®å¯ä¸´æ—¶è°ƒæ•´åˆ†ç»„é€»è¾‘ã€‚</small>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadDefaultConfig()">é‡ç½®é»˜è®¤</button>
                                        </div>
                                        <textarea class="form-control" id="configEditor" rows="12" style="font-family: monospace; font-size: 0.85rem; background-color: #f8f9fa;"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸‹è½½åŒºåŸŸ -->
                        <div id="processDownloadArea" class="download-area text-center">
                            <p class="mb-2 text-success fw-bold">âœ… å¤„ç†æˆåŠŸï¼</p>
                            <a href="#" id="processDownloadBtn" class="btn btn-sm btn-outline-success">
                                â¬‡ï¸ ä¸‹è½½ç»“æœæ–‡ä»¶
                            </a>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="submitProcess()">å¼€å§‹å¤„ç†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† 2: æ‰¹é‡åˆå¹¶ -->
    <div class="modal fade" id="mergeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ‰¹é‡åˆå¹¶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="mergeForm">
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹©å¤šä¸ªæ–‡ä»¶</label>
                            <input type="file" class="form-control" id="mergeFiles" multiple accept=".xls,.xlsx">
                            <div class="form-text">æŒ‰ä½ Ctrl æˆ– Shift å¯å¤šé€‰ï¼Œæ”¯æŒ .xls å’Œ .xlsx</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è‡ªå®šä¹‰è¾“å‡ºæ–‡ä»¶å (å¯é€‰)</label>
                            <input type="text" class="form-control" id="outputFilename" placeholder="ä¾‹å¦‚: 2025ç¬¬ä¸€å­£åº¦æ±‡æ€»">
                        </div>

                        <!-- ä¸‹è½½åŒºåŸŸ -->
                        <div id="mergeDownloadArea" class="download-area text-center">
                            <p class="mb-2 text-success fw-bold">âœ… åˆå¹¶æˆåŠŸï¼</p>
                            <a href="#" id="mergeDownloadBtn" class="btn btn-sm btn-outline-success">
                                â¬‡ï¸ ä¸‹è½½æ±‡æ€»æ–‡ä»¶
                            </a>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-success" onclick="submitMerge()">å¼€å§‹åˆå¹¶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast æç¤ºæ¡† -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">æç¤º</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                æ“ä½œæˆåŠŸï¼
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // åˆå§‹åŒ–ï¼šåŠ è½½é…ç½®
        document.addEventListener('DOMContentLoaded', () => {
            loadDefaultConfig();
        });

        // åŠ è½½é»˜è®¤é…ç½®
        async function loadDefaultConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    document.getElementById('configEditor').value = JSON.stringify(config, null, 4);
                } else {
                    console.error("Failed to load default config");
                    document.getElementById('configEditor').value = "// åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—";
                }
            } catch (e) {
                console.error("Error fetching config:", e);
            }
        }

        // åˆå§‹åŒ–ï¼šç›‘å¬æ¨¡æ€æ¡†å…³é—­ï¼Œé‡ç½®è¡¨å•å’Œä¸‹è½½åŒº
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('hidden.bs.modal', event => {
                const form = modal.querySelector('form');
                if(form) form.reset();
                const downloadArea = modal.querySelector('.download-area');
                if(downloadArea) downloadArea.style.display = 'none';
                
                // é‡ç½®é…ç½®ç¼–è¾‘å™¨ä¸ºé»˜è®¤å€¼ (å¦‚æœç”¨æˆ·ä¿®æ”¹è¿‡ï¼Œè¿™é‡Œæœ€å¥½é‡ç½®å›å»)
                if (modal.id === 'processModal') {
                    loadDefaultConfig(); // æ¯æ¬¡å…³é—­é‡æ–°åŠ è½½é»˜è®¤å€¼ï¼Œç¡®ä¿"ä¸´æ—¶ä¿®æ”¹"åªç”Ÿæ•ˆä¸€æ¬¡
                }

                // é‡ç½®æŒ‰é’®çŠ¶æ€
                const btn = modal.querySelector('.modal-footer button:last-child');
                if(btn) {
                    btn.disabled = false;
                    btn.textContent = btn.classList.contains('btn-success') ? 'å¼€å§‹åˆå¹¶' : 'å¼€å§‹å¤„ç†';
                }
            });
        });

        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('liveToast');
            const toastBody = document.getElementById('toastBody');
            const toastTitle = document.getElementById('toastTitle');
            
            toastBody.textContent = message;
            if (type === 'success') {
                toastEl.classList.remove('text-bg-danger');
                toastEl.classList.add('text-bg-success');
                toastTitle.textContent = "æˆåŠŸ";
            } else {
                toastEl.classList.remove('text-bg-success');
                toastEl.classList.add('text-bg-danger');
                toastTitle.textContent = "é”™è¯¯";
            }
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // æäº¤å•æ–‡ä»¶å¤„ç†
        async function submitProcess() {
            const fileInput = document.getElementById('srcFile');
            const configEditor = document.getElementById('configEditor');
            const downloadArea = document.getElementById('processDownloadArea');
            const downloadBtn = document.getElementById('processDownloadBtn');
            
            if (fileInput.files.length === 0) {
                showToast("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶", 'error');
                return;
            }

            // éªŒè¯ JSON æ ¼å¼
            let configVal = configEditor.value;
            try {
                JSON.parse(configVal);
            } catch (e) {
                showToast("é…ç½®æ ¼å¼é”™è¯¯: è¯·ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®", 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('config', configVal);

            const btn = document.querySelector('#processModal .btn-primary');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'å¤„ç†ä¸­...';
            downloadArea.style.display = 'none';

            try {
                const response = await fetch('/api/process_data', {
                    method: 'POST',
                    body: formData // è‡ªåŠ¨è®¾ç½® Content-Type ä¸º multipart/form-data
                });
                
                const data = await response.json();
                if (response.ok) {
                    showToast(data.message, 'success');
                    // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                    downloadBtn.href = data.download_url;
                    downloadBtn.textContent = "â¬‡ï¸ ä¸‹è½½: " + data.filename;
                    downloadArea.style.display = 'block';
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast("è¯·æ±‚å¤±è´¥: " + error, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // æäº¤æ‰¹é‡åˆå¹¶
        async function submitMerge() {

            const fileInput = document.getElementById('mergeFiles');
            const outputFilename = document.getElementById('outputFilename').value;
            const downloadArea = document.getElementById('mergeDownloadArea');
            const downloadBtn = document.getElementById('mergeDownloadBtn');

            if (fileInput.files.length === 0) {
                showToast("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶", 'error');
                return;
            }

            const formData = new FormData();
            for (const file of fileInput.files) {
                formData.append('files', file);
            }
            if (outputFilename) {
                formData.append('output_filename', outputFilename);
            }

            const btn = document.querySelector('#mergeModal .btn-success');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'åˆå¹¶ä¸­...';
            downloadArea.style.display = 'none';

            try {
                const response = await fetch('/api/merge_files', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    showToast(data.message, 'success');
                    // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                    downloadBtn.href = data.download_url;
                    downloadBtn.textContent = "â¬‡ï¸ ä¸‹è½½: " + data.filename;
                    downloadArea.style.display = 'block';
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast("è¯·æ±‚å¤±è´¥: " + error, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    </script>
</body>
</html>